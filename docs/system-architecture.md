# MCP LLM Generator システム構成図

## 概要

VS Code を MCPクライアントとして、複数の MCP サーバーが協調して動作するシステムアーキテクチャ。

## システム構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        VS Code (MCPクライアント)                │
│─────────────────────────────────────────────────────────────────│
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│  │   UI    │  │  管理   │  │キャッシュ│  │ライフサイ│           │
│  │表示制御 │  │ 制御    │  │ 一時保存│  │クル管理  │           │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘           │
└─────────────────┬───────────────────────────────────────────────┘
                  │ stdio / JSON-RPC プロトコル
                  │
        ┌─────────┼─────────┬─────────────┬─────────────┐
        │         │         │             │             │
        ▼         ▼         ▼             ▼             ▼
┌───────────┐ ┌───────────┐ ┌─────────────┐ ┌─────────────┐
│llm-generator│ │assoc-memory│ │mcp-shell-ser│ │   google    │
│─────────────│ │───────────│ │─────────────│ │─────────────│
│外部LLM API │ │連想メモリ │ │シェルコマンド│ │Google API   │
│統合・管理  │ │管理・検索 │ │実行・管理   │ │検索・統合   │
│─────────────│ │───────────│ │─────────────│ │─────────────│
│• OpenAI     │ │• ベクトルDB│ │• プロセス管理│ │• 検索API    │
│• Claude     │ │• 永続化   │ │• セキュリティ│ │• 結果取得   │
│• コンテキスト│ │• 関連性検索│ │• 出力管理   │ │             │
└─────┬───────┘ └─────┬─────┘ └───────┬─────┘ └───────┬─────┘
      │               │               │               │
      ▼               ▼               ▼               ▼
┌───────────┐ ┌───────────┐ ┌─────────────┐ ┌─────────────┐
│永続化層   │ │永続化層   │ │永続化層     │ │永続化層     │
│───────────│ │───────────│ │─────────────│ │─────────────│
│SQLite DB  │ │ChromaDB   │ │ログファイル │ │キャッシュ   │
│context-   │ │ベクトル   │ │実行履歴     │ │検索結果     │
│memory.db  │ │ストレージ │ │出力ファイル │ │             │
└───────────┘ └───────────┘ └─────────────┘ └─────────────┘
```

## 詳細説明

### VS Code (MCPクライアント)

- **役割**: 各MCPサーバーのライフサイクル管理とユーザーインターフェース提供
- **機能**:
  - UI表示制御
  - MCPサーバーの起動・停止・再起動制御
  - ツール情報のキャッシュ管理
  - function_call の実行とレスポンス処理

### MCPサーバー群

#### 1. llm-generator
- **目的**: 外部LLM API統合とコンテキスト管理
- **機能**:
  - OpenAI/Claude API連携
  - 人格・コンテキスト管理
  - 会話履歴の永続化
  - テンプレート管理
- **永続化**: SQLite データベース (`context-memory.db`)

#### 2. assoc-memory
- **目的**: 連想記憶・ナレッジベース管理
- **機能**:
  - ベクトルベース類似性検索
  - メモリ間の関連性発見
  - スコープ・タグ管理
  - セッション管理
- **永続化**: ChromaDB ベクトルストレージ

#### 3. mcp-shell-server
- **目的**: シェルコマンド実行・プロセス管理
- **機能**:
  - セキュアなコマンド実行
  - プロセス監視・制御
  - 出力管理・ログ記録
  - ターミナルセッション管理
- **永続化**: ログファイル・実行履歴

#### 4. google
- **目的**: Google API 統合・外部情報取得
- **機能**:
  - Google 検索API連携
  - 検索結果の構造化
  - キャッシュ・ページネーション
- **永続化**: 検索結果キャッシュ

## 通信プロトコル

### MCP over JSON-RPC
- **通信方式**: stdio (標準入出力)
- **プロトコル**: JSON-RPC 2.0
- **方向**: 双方向通信 (VS Code ↔ MCPサーバー)

### メッセージ種別
1. **Tools**: 利用可能ツールの情報
2. **Tool Call**: ツール実行要求
3. **Resources**: リソース情報取得
4. **Prompts**: プロンプトテンプレート
5. **Sampling**: LLMサンプリング要求

## ライフサイクル管理

### サーバー起動フロー
1. VS Code が `.vscode/mcp.json` 設定を読み込み
2. 必要に応じてMCPサーバーを起動
3. サーバーとの通信確立・ハンドシェイク
4. ツール・リソース情報の取得・キャッシュ

### サーバー停止・再起動
1. VS Code UI からユーザー操作
2. 外部プロセス（kill コマンド等）による強制終了
3. プログラムの自発終了（エラーを含む）
4. function_call 実行時の自動再起動

## データフロー

### 永続化戦略
- **各MCPサーバー**: 独自の永続化層を持つ
- **VS Code**: ツール情報等の一時キャッシュのみ
- **データ復旧**: サーバー再起動時に永続化層から自動復元

### キャッシュ管理
- **VS Code側**: ツール情報、スキーマ情報
- **サーバー側**: 一時的な実行結果、セッション情報
- **同期**: サーバー再起動時にキャッシュと永続化データの整合性確保

## 運用・保守

### 拡張性
- 新MCPサーバーの追加が容易
- 既存サーバーの独立した更新・再起動
- モジュラー設計による責務分離

### 監視・トラブルシューティング
- 各サーバーの独立したログ出力
- VS Code からのサーバー状態監視
- プロセス単位での問題特定・対応

### セキュリティ
- stdio通信による安全な通信路
- 各サーバーの独立したセキュリティ設定
- 外部API キーの環境変数管理

## 設定管理

### 設定ファイル: `.vscode/mcp.json`
```json
{
  "servers": {
    "llm-generator": {
      "type": "stdio",
      "command": "node",
      "args": ["build/index.js"],
      "env": {
        "ANTHROPIC_API_KEY": "...",
        "NODE_ENV": "production"
      }
    },
    "assoc-memory": {
      "type": "stdio", 
      "command": "python",
      "args": ["-m", "mcp_assoc_memory.server"]
    }
    // ... 他のサーバー
  }
}
```

## まとめ

本システムは VS Code を中心とした疎結合なマイクロサービス型アーキテクチャを採用し、各MCPサーバーが独立した責務を持ちながら協調動作する設計となっている。これにより高い拡張性・保守性・運用性を実現している。
